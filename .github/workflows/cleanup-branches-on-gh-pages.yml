name: Cleanup Orphaned Branch Deployments

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  dryrun-cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Checkout main branch to main-branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch
          fetch-depth: 0

      - name: Dry-run - Show what would be cleaned up
        run: |
          echo "=== Current remote branches ==="
          git fetch origin
          git branch -r | grep 'origin/' | grep -v 'origin/gh-pages' | sed 's|origin/||'
          echo

          echo "=== Directories in gh-pages root ==="
          for dir in */ ; do
            echo "${dir%/}"
          done
          echo

          echo "=== Directories in main branch root ==="
          ls -d main-branch/*/ 2>/dev/null | sed 's|main-branch/||;s|/||'
          echo

          # Build list of current branch deployment dirs
          keep_dirs=""
          for branch in $(git branch -r | grep 'origin/' | grep -v 'origin/gh-pages' | sed 's|origin/||'); do
            if [ "$branch" = "main" ]; then
              continue
            elif [ "$branch" = "development" ]; then
              keep_dirs="$keep_dirs dev"
            else
              keep_dirs="$keep_dirs ${branch//\//-}"
            fi
          done
          echo "=== Branch deployment directories (should exist if branch exists) ==="
          for d in $keep_dirs; do
            echo "$d"
          done
          echo

          echo "=== Dry-run: What would be deleted ==="
          for dir in */ ; do
            dir=${dir%/}
            # If dir exists in main, skip (it's part of main's deployment)
            if [ -d "main-branch/$dir" ]; then
              echo "KEEP (in main): $dir"
              continue
            fi
            # Only consider deleting if it's a branch deployment dir
            if echo "$keep_dirs" | grep -wq "$dir"; then
              echo "KEEP (active branch): $dir"
            else
              echo "DELETE (orphaned branch deployment): $dir"
            fi
          done